# 🛠️ ESP32控制板CAN工具集完整说明

## 📋 工具概述

我为您的ESP32控制板项目创建了一套完整的CAN设备检测、配置和测试工具。这些工具完全兼容您的ESP32项目配置，可以帮助您：

- 检测和配置CAN设备
- 测试CAN通信
- 模拟ESP32的电机控制命令
- 监控CAN总线消息
- 验证与LKBLS481502电机驱动器的通信

## 📁 文件清单

| 文件名 | 类型 | 功能描述 |
|--------|------|----------|
| `can_tool.py` | Python脚本 | 完整功能的CAN工具主程序 |
| `can_detector.py` | Python模块 | CAN设备检测和配置核心类 |
| `quick_can_setup.py` | Python脚本 | 简化的快速配置工具 |
| `can_tool.bat` | 批处理脚本 | Windows系统快速启动脚本 |
| `install.bat` | 安装脚本 | 自动安装依赖和配置环境 |
| `test_can_tools.py` | 测试脚本 | 工具功能验证和测试 |
| `requirements.txt` | 依赖文件 | Python包依赖管理 |
| `README.md` | 文档 | 详细使用说明和教程 |
| `工具说明.md` | 文档 | 本说明文件 |

## 🎯 核心功能

### 1. 自动检测CAN接口
- 支持多种CAN接口类型：SocketCAN、PEAK CAN、Vector CAN、Kvaser CAN、USB2CAN、串口CAN
- 自动扫描系统中可用的CAN设备
- 智能识别设备类型和通道

### 2. ESP32兼容配置
- 自动配置250kbps波特率（匹配ESP32 TWAI_TIMING_CONFIG_250KBITS()）
- 使用扩展帧格式（29位ID）
- CAN ID: 0x06000001（与ESP32项目完全一致）

### 3. 电机控制命令
完全兼容ESP32项目的LKBLS481502电机控制协议：

#### 使能电机命令
```
CAN ID: 0x06000001
数据: [0x23, 0x0D, 0x20, channel, 0x00, 0x00, 0x00, 0x00]
```

#### 禁用电机命令
```
CAN ID: 0x06000001
数据: [0x23, 0x0C, 0x20, channel, 0x00, 0x00, 0x00, 0x00]
```

#### 速度控制命令
```
CAN ID: 0x06000001
数据: [0x23, 0x00, 0x20, channel, speed_byte3, speed_byte2, speed_byte1, speed_byte0]
```

### 4. 差速控制测试
模拟ESP32项目的差速控制逻辑：
- 前进/后退
- 左转/右转
- 原地转向
- 停止

### 5. 实时监控
- 实时显示CAN总线上的所有消息
- 时间戳精确到毫秒
- 支持扩展帧和标准帧显示
- 十六进制数据格式

## 🚀 快速开始指南

### 步骤1: 安装环境
```cmd
# 运行自动安装脚本
install.bat
```

### 步骤2: 连接CAN设备
- 将CAN接口设备连接到计算机
- 确保CAN总线有120Ω终端电阻
- 连接到LKBLS481502电机驱动器

### 步骤3: 运行工具
```cmd
# Windows用户（推荐）
can_tool.bat

# 或快速配置模式
python quick_can_setup.py

# 或完整功能模式
python can_tool.py
```

## 🎮 使用场景

### 场景1: 初次测试CAN通信
1. 运行 `python quick_can_setup.py`
2. 选择"快速电机测试"
3. 观察电机是否响应

### 场景2: 调试CAN问题
1. 在一个终端运行 `python can_tool.py --monitor`
2. 在另一个终端运行 `python can_tool.py --test-motor`
3. 观察CAN消息传输情况

### 场景3: 验证ESP32兼容性
1. 使用工具发送与ESP32相同格式的命令
2. 确认电机驱动器响应正确
3. 对比ESP32和工具的CAN消息格式

## ⚙️ 配置参数

### ESP32兼容配置
```python
esp32_config = {
    'bitrate': 250000,        # 250kbps，匹配ESP32 TWAI
    'extended_id': True,      # 扩展帧
    'motor_base_id': 0x06000001,  # CAN ID
}
```

### 电机控制参数
- **通道**: 1=左电机, 2=右电机
- **速度范围**: -100~+100 (应用层)
- **驱动器速度**: -10000~+10000 (speed * 100)
- **数据格式**: 32位有符号整数，高字节在前

## 🔧 高级功能

### 1. 批量测试
```python
# 自动化测试序列
test_sequences = [
    ("停止", 0, 0),
    ("前进", 50, 50),
    ("后退", -50, -50),
    ("左转", -30, 30),
    ("右转", 30, -30),
]
```

### 2. 状态监控
- CAN总线状态检查
- 错误计数器监控
- 发送成功率统计
- 队列状态显示

### 3. 调试输出
- 详细的CAN消息日志
- 错误信息和解决建议
- 性能统计信息

## 🐛 故障排除

### 常见问题及解决方案

#### 1. 未检测到CAN接口
**检查项目**:
- CAN设备是否正确连接
- 驱动程序是否已安装
- 设备权限是否正确

#### 2. 连接失败
**检查项目**:
- 波特率是否匹配（250kbps）
- CAN总线终端电阻（120Ω）
- 设备是否被其他程序占用

#### 3. 电机无响应
**检查项目**:
- CAN ID是否正确（0x06000001）
- 命令格式是否符合协议
- 电机驱动器是否上电
- CAN总线连接是否正常

## 📊 性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| 波特率 | 250 kbps | 匹配ESP32 TWAI配置 |
| 帧格式 | CAN 2.0B扩展帧 | 29位ID + 8字节数据 |
| 发送延迟 | < 10ms | 软件处理时间 |
| 监控精度 | 微秒级 | 时间戳精度 |
| 支持接口 | 6种类型 | 覆盖主流CAN设备 |

## 🔗 相关资源

- [ESP32控制板项目](../README.md)
- [CAN模块文档](../docs/modules/can-module.md)
- [硬件原理图](../docs/hardware/schematic.md)
- [python-can官方文档](https://python-can.readthedocs.io/)

## 📝 开发说明

### 代码结构
```
tools/
├── can_detector.py      # 核心检测类
├── can_tool.py         # 主程序入口
├── quick_can_setup.py  # 快速配置工具
└── test_can_tools.py   # 测试套件
```

### 扩展开发
如需添加新功能，可以：
1. 继承 `CANDetector` 类
2. 添加新的命令格式
3. 扩展接口检测逻辑
4. 增加监控功能

## 🎉 总结

这套CAN工具集为您的ESP32控制板项目提供了完整的CAN通信测试和验证解决方案。工具设计完全兼容您的ESP32项目配置，可以有效帮助您：

- ✅ 快速验证CAN硬件连接
- ✅ 测试电机控制命令
- ✅ 调试CAN通信问题
- ✅ 监控CAN总线状态
- ✅ 验证ESP32兼容性

使用这些工具，您可以在不依赖ESP32硬件的情况下，独立测试和验证CAN通信功能，大大提高开发效率！

---

💡 **提示**: 如有任何问题或需要功能扩展，请随时联系！
