# ESP32 编译、烧录、监控脚本使用指南

## 📋 脚本概述

本项目提供了3个Windows批处理脚本，用于ESP32项目的编译、烧录和串口监控：

1. **check_env.bat** - 检查编译环境
2. **build.bat** - 编译ESP32项目
3. **flash.bat** - 烧录固件到ESP32
4. **monitor.bat** - 监控ESP32串口输出

## 🚀 快速开始

### 1. 检查环境

首先运行环境检查脚本，确保ESP-IDF环境配置正确：

```batch
check_env.bat
```

**检查内容**：
- ✅ ESP-IDF路径是否存在
- ✅ Python环境是否正确
- ✅ 项目配置文件是否完整
- ✅ 串口设备是否可用
- ✅ ESP-IDF环境是否可以正常激活

### 2. 编译项目

运行编译脚本，编译ESP32固件：

```batch
build.bat
```

**功能特点**：
- 自动激活ESP-IDF环境
- 检查是否需要清理旧文件
- 显示编译进度和结果
- 编译成功后显示固件文件信息
- 显示固件大小分析

**编译输出文件**：
- `build/esp32controlboard.bin` - 主程序固件
- `build/bootloader/bootloader.bin` - 引导程序
- `build/partition_table/partition-table.bin` - 分区表
- `build/ota_data_initial.bin` - OTA数据

### 3. 烧录固件

运行烧录脚本，将编译好的固件烧录到ESP32：

```batch
flash.bat
```

**功能特点**：
- 自动检测可用串口设备
- 支持多个串口设备选择
- 检查固件文件是否存在
- 显示详细的烧录信息
- 烧录成功后可选择启动串口监控

**烧录步骤**：
1. 脚本自动检测串口设备
2. 如果有多个串口，选择目标端口
3. 确认烧录信息
4. 开始烧录固件
5. 烧录完成后可选择启动监控

### 4. 监控串口

运行监控脚本，查看ESP32的串口输出：

```batch
monitor.bat
```

**功能特点**：
- 自动检测可用串口设备
- 支持多个串口设备选择
- 显示监控快捷键提示
- 实时显示ESP32日志输出

**监控快捷键**：
- `Ctrl+]` - 退出监控
- `Ctrl+T` - 显示菜单
- `Ctrl+T` `Ctrl+R` - 重启ESP32
- `Ctrl+T` `Ctrl+F` - 切换日志过滤

## 🔧 脚本配置

### 默认配置

脚本中使用的默认配置（可在脚本中修改）：

```batch
set PROJECT_NAME=esp32controlboard
set IDF_PATH=C:\Espressif\frameworks\esp-idf-v5.4.1
set IDF_PYTHON_ENV_PATH=C:\Espressif\python_env\idf5.4_py3.11_env
set DEFAULT_PORT=COM10
set DEFAULT_BAUD=460800  # 烧录波特率
set DEFAULT_BAUD=115200 # 监控波特率
```

### 修改配置

如果需要修改配置，编辑对应的脚本文件，修改上述变量值。

## 📝 使用示例

### 完整工作流程

```batch
# 1. 检查环境
check_env.bat

# 2. 编译项目
build.bat

# 3. 烧录固件
flash.bat

# 4. 监控串口（如果需要）
monitor.bat
```

### 一键编译+烧录+监控

```batch
# 编译并烧录，然后启动监控
build.bat && flash.bat && monitor.bat
```

或者使用flash.bat的交互选项，烧录完成后选择启动监控。

## ⚠️ 常见问题

### 1. 环境检查失败

**问题**：ESP-IDF路径或Python环境不存在

**解决**：
- 检查ESP-IDF安装路径是否正确
- 确认Python环境路径是否正确
- 运行ESP-IDF安装脚本重新配置环境

### 2. 编译失败

**问题**：编译过程中出现错误

**解决**：
- 检查源代码语法错误
- 清理编译目录：删除`build`文件夹
- 重新配置：运行`idf.py reconfigure`
- 检查CMakeLists.txt配置

### 3. 烧录失败

**问题**：无法连接到ESP32

**解决**：
- 检查USB连接
- 确认串口驱动已安装（CH340或CP2102）
- 手动进入下载模式：
  1. 按住BOOT键
  2. 按下并松开RESET键
  3. 松开BOOT键
  4. 重新运行flash.bat
- 尝试使用较低波特率：修改脚本中的`DEFAULT_BAUD`为115200

### 4. 串口监控无输出

**问题**：烧录成功但串口无输出

**解决**：
- 检查ESP32是否正常启动（按RESET键）
- 确认波特率正确（默认115200）
- 检查串口是否被其他程序占用
- 尝试重新连接USB线

### 5. 串口被占用

**问题**：串口被其他程序占用

**解决**：
- 关闭其他使用串口的程序（如Arduino IDE、串口助手等）
- 在设备管理器中检查串口状态
- 重新插拔USB线

## 📊 脚本输出说明

### check_env.bat 输出

```
========================================================
         ESP32 编译环境检查工具
========================================================

[检查 1/8] ESP-IDF路径...
  [✓] ESP-IDF路径存在: C:\Espressif\frameworks\esp-idf-v5.4.1
[检查 2/8] Python环境...
  [✓] Python环境存在: C:\Espressif\python_env\idf5.4_py3.11_env
...

========================================================
                  检查结果总结
========================================================

总检查项: 8
通过:     6
失败:     0
警告:     2

[✓] 环境检查通过！可以开始编译和烧录。
```

### build.bat 输出

```
========================================================
           ESP32 项目编译工具
========================================================

[步骤 1/3] 激活ESP-IDF环境...
[✓] ESP-IDF环境已激活

[步骤 2/3] 准备编译...

[步骤 3/3] 开始编译项目...
========================================

...

========================================
[✓] 编译成功完成！
========================================

编译输出文件:
----------------------------------------
  [✓] 主程序: esp32controlboard.bin (123456 bytes)
  [✓] 引导程序: bootloader.bin (23456 bytes)
  [✓] 分区表: partition-table.bin (3072 bytes)
```

### flash.bat 输出

```
========================================================
           ESP32 固件烧录工具
========================================================

[步骤 1/4] 检测串口设备...
----------------------------------------
  发现串口: COM10
----------------------------------------

[信息] 自动选择串口: COM10

[步骤 2/4] 准备烧录信息...
----------------------------------------
目标设备: ESP32
串口端口: COM10
波特率:   460800
项目名称: esp32controlboard
----------------------------------------

[步骤 3/4] 检查固件文件...
...

[步骤 4/4] 激活ESP-IDF环境并开始烧录...
========================================

正在烧录固件到 COM10...
...

========================================
[✓] 烧录成功完成！
========================================
```

## 🔗 相关文档

- [环境搭建指南](docs/01-开发指南/环境搭建指南.md)
- [编译烧录指南](docs/01-开发指南/编译烧录指南.md)
- [调试方法指南](docs/01-开发指南/调试方法指南.md)

## 💡 提示

1. **首次使用**：建议先运行`check_env.bat`检查环境配置
2. **快速开发**：修改代码后直接运行`build.bat`编译，然后`flash.bat`烧录
3. **调试模式**：使用`monitor.bat`实时查看ESP32日志输出
4. **自动化**：可以将脚本添加到IDE的任务配置中，实现一键编译烧录

---

**版本**: 1.0.0  
**最后更新**: 2024-11-04

