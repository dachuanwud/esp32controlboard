# 🎮 功能控制指令

本文档定义了 ESP32 控制板的功能控制指令协议，用于通过 CAN 总线或网络接口控制履带车的各项功能。

---

## 一、协议概述

| 参数 | 值 | 说明 |
|------|-----|------|
| **帧类型** | 扩展帧（29-bit ID） | 与电机驱动器协议一致 |
| **控制指令 ID** | `0x1FF` | 功能控制指令帧 ID |
| **数据长度** | 8 字节 | 固定长度 |
| **CAN 波特率** | 250 Kbps | 与电机驱动器一致 |
| **协议版本** | V1.0 | 当前版本 |

---

## 二、数据帧格式

### 2.1 帧结构

```
字节位置:  [0]      [1]      [2]      [3]      [4]      [5]      [6]      [7]
数据内容:  MODE    ESTOP    PARK    REMOTE   BRAKE   RESERVED ENABLE   LOWSPD
```

### 2.2 数据帧定义

| Byte | 信号描述 | 精度 | 偏移量 | 单位 | 数据类型 | 信号值描述 |
|------|---------|------|--------|------|---------|-----------|
| **Byte 0** | 运动模式 | - | - | - | unsigned | 1: 差速模式（履带车标准模式）<br>2: 原地旋转模式（仅角速度）<br>3: 阿克曼模式（预留）<br>其他: 无效 |
| **Byte 1** | 急停 | - | - | - | unsigned | 1: 开启急停（立即停止所有运动）<br>2: 关闭急停（恢复正常控制）<br>其他: 无效 |
| **Byte 2** | 驻车锁定 | - | - | - | unsigned | 1: 开启驻车（锁定电机位置）<br>2: 关闭驻车（解除锁定）<br>其他: 无效 |
| **Byte 3** | 遥控使能 | - | - | - | unsigned | 1: 开启遥控（允许SBUS控制）<br>2: 关闭遥控（禁用SBUS控制）<br>其他: 无效 |
| **Byte 4** | 刹车力度 | 1 | 0 | % | unsigned | 有效范围: 1~100%<br>0xFF: 关闭刹车<br>其他: 无效 |
| **Byte 5** | 预留 | - | - | - | unsigned | 预留字段，当前未使用 |
| **Byte 6** | 驱动器使能 | - | - | - | unsigned | 1: 使能驱动器（允许电机运行）<br>2: 失能驱动器（停止电机）<br>其他: 无效 |
| **Byte 7** | 低速模式 | - | - | - | unsigned | 1: 开启低速模式（速度限制为20%）<br>2: 关闭低速模式（正常速度范围）<br>其他: 无效 |

---

## 三、功能说明

### 3.1 运动模式（Byte 0）

| 值 | 模式 | 说明 |
|----|------|------|
| 1 | 差速模式 | 履带车标准控制模式，通过左右履带速度差实现转向 |
| 2 | 原地旋转模式 | 仅使用角速度控制，左右履带反向运动实现原地旋转 |
| 3 | 阿克曼模式 | 预留，用于多轮多转底盘（当前不支持） |

**默认值：** 1（差速模式）

### 3.2 急停（Byte 1）

急停功能用于紧急情况下立即停止所有运动。

| 值 | 状态 | 说明 |
|----|------|------|
| 1 | 开启急停 | 立即停止所有电机运动，忽略其他控制命令 |
| 2 | 关闭急停 | 恢复正常控制，允许执行运动命令 |

**安全特性：**
- 急停开启时，所有运动命令将被忽略
- 急停状态优先于其他所有控制命令
- 建议在紧急情况下使用

**默认值：** 2（关闭急停）

### 3.3 驻车锁定（Byte 2）

驻车功能用于锁定电机位置，防止车辆滑动。

| 值 | 状态 | 说明 |
|----|------|------|
| 1 | 开启驻车 | 锁定电机位置，保持当前位置 |
| 2 | 关闭驻车 | 解除锁定，允许正常运动 |

**默认值：** 2（关闭驻车）

### 3.4 遥控使能（Byte 3）

遥控使能控制是否允许通过 SBUS 遥控器控制车辆。

| 值 | 状态 | 说明 |
|----|------|------|
| 1 | 开启遥控 | 允许 SBUS 遥控器控制（CH4 <= 1100） |
| 2 | 关闭遥控 | 禁用 SBUS 遥控器控制，仅允许网络/API 控制 |

**默认值：** 2（关闭遥控，需手动开启）

### 3.5 刹车力度（Byte 4）

刹车力度控制电机制动强度。

| 值 | 说明 |
|----|------|
| 1~100 | 刹车力度百分比（1% = 最轻，100% = 最强） |
| 0xFF | 关闭刹车 |

**计算公式：**
```
实际刹车力度 = Byte 4 值（当 Byte 4 != 0xFF）
```

**默认值：** 0xFF（关闭刹车）

### 3.6 预留字段（Byte 5）

当前未使用，保留用于未来功能扩展。

**默认值：** 0x00

### 3.7 驱动器使能（Byte 6）

驱动器使能控制电机驱动器的工作状态。

| 值 | 状态 | 说明 |
|----|------|------|
| 1 | 使能驱动器 | 允许电机运行，可以接收速度/位置命令 |
| 2 | 失能驱动器 | 停止电机，驱动器进入待机状态 |

**注意：** 失能驱动器后，需要重新使能才能恢复控制。

**默认值：** 1（使能驱动器）

### 3.8 低速模式（Byte 7）

低速模式用于限制车辆最大速度，提高控制精度。

| 值 | 状态 | 说明 |
|----|------|------|
| 1 | 开启低速模式 | 速度范围限制为 -20 ~ +20（正常范围的20%） |
| 2 | 关闭低速模式 | 正常速度范围 -100 ~ +100 |

**速度缩放：**
```
低速模式开启时：实际速度 = 原始速度 × 0.2
低速模式关闭时：实际速度 = 原始速度
```

**默认值：** 2（关闭低速模式）

---

## 四、使用示例

### 4.1 CAN 总线发送示例

```c
// 发送功能控制指令
void send_function_control(uint8_t mode, uint8_t estop, uint8_t park, 
                          uint8_t remote, uint8_t brake, uint8_t enable, 
                          uint8_t lowspd) {
    uint8_t tx_data[8] = {0};
    uint32_t tx_id = 0x1FF;  // 功能控制指令 ID
    
    tx_data[0] = mode;      // 运动模式
    tx_data[1] = estop;     // 急停
    tx_data[2] = park;      // 驻车
    tx_data[3] = remote;    // 遥控使能
    tx_data[4] = brake;     // 刹车力度
    tx_data[5] = 0x00;      // 预留
    tx_data[6] = enable;    // 驱动器使能
    tx_data[7] = lowspd;    // 低速模式
    
    // 发送 CAN 帧
    keya_send_data(tx_id, tx_data);
}
```

### 4.2 典型场景示例

#### 场景1：正常启动
```c
// 差速模式、关闭急停、关闭驻车、开启遥控、关闭刹车、使能驱动器、关闭低速模式
send_function_control(1, 2, 2, 1, 0xFF, 1, 2);
// 数据: 01 02 02 01 FF 00 01 02
```

#### 场景2：紧急停止
```c
// 开启急停，其他参数保持
send_function_control(1, 1, 2, 1, 0xFF, 1, 2);
// 数据: 01 01 02 01 FF 00 01 02
```

#### 场景3：低速精确控制
```c
// 开启低速模式
send_function_control(1, 2, 2, 1, 0xFF, 1, 1);
// 数据: 01 02 02 01 FF 00 01 01
```

#### 场景4：驻车锁定
```c
// 开启驻车锁定
send_function_control(1, 2, 1, 1, 0xFF, 1, 2);
// 数据: 01 02 01 01 FF 00 01 02
```

#### 场景5：网络控制模式（禁用遥控）
```c
// 关闭遥控使能，仅允许网络/API控制
send_function_control(1, 2, 2, 2, 0xFF, 1, 2);
// 数据: 01 02 02 02 FF 00 01 02
```

---

## 五、状态优先级

功能控制指令的状态优先级如下（从高到低）：

1. **急停（Byte 1 = 1）** - 最高优先级，立即停止所有运动
2. **驻车锁定（Byte 2 = 1）** - 锁定电机位置
3. **驱动器使能（Byte 6 = 2）** - 失能时无法控制
4. **遥控使能（Byte 3 = 2）** - 禁用时忽略SBUS输入
5. **低速模式（Byte 7 = 1）** - 限制速度范围
6. **运动模式（Byte 0）** - 控制算法选择
7. **刹车力度（Byte 4）** - 制动控制

---

## 六、注意事项

1. **默认值：** 控制板上电后，所有功能控制参数使用默认值（见各功能说明）
2. **状态保持：** 功能控制指令的状态会保持，直到收到新的指令
3. **急停优先：** 急停开启时，其他所有控制命令将被忽略
4. **遥控使能：** 关闭遥控使能后，SBUS 遥控器输入将被忽略，仅允许通过网络/API 控制
5. **驱动器使能：** 失能驱动器后，需要重新使能才能恢复电机控制
6. **低速模式：** 低速模式下，速度范围限制为正常范围的 20%，适用于精确控制场景
7. **CAN 总线：** 功能控制指令通过 CAN 总线发送，确保与电机驱动器协议兼容

---

## 七、协议版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| V1.0 | 2024 | 初始版本，定义8字节功能控制指令 |

---

## 八、相关文档

- [CAN通信协议总结](./can_protocol_summary.md) - LKBLS481502 驱动器协议
- [控制器心跳协议](./控制器心跳协议.md) - 多控制器仲裁协议
- [CAN通信模块文档](../02-模块文档/CAN通信模块.md) - CAN 总线实现细节


