# 🧭 LKBLS481502 CAN 通信协议总结

以下总结基于《LKBLS481502 双通道伺服电机驱动器说明书》的 **CAN 总线通信协议章节（第20–25页）**。

---

## 一、通用配置

| 参数 | 说明 |
|------|------|
| **波特率** | 默认 **250 Kbps**（可配置为 100K–500K） |
| **帧格式** | 扩展帧（Extended Frame, 29-bit ID） |
| **数据格式** | 16 进制 HEX |
| **心跳频率** | 1 Hz（自动上传） |
| **看门狗周期** | 1000 ms（控制命令间隔不得超过 1s） |
| **发送 ID** | `0x0600000 + 驱动器地址`（出厂默认地址 1） |
| **反馈 ID** | `0x0580000 + 驱动器地址` |
| **心跳 ID** | `0x0700000 + 驱动器地址` |

---

## 二、控制命令格式

命令格式采用 8 字节数据帧，以下为各功能说明：

### 1️⃣ 使能 / 失能命令

| 功能 | 指令 | 说明 |
|------|------|------|
| A 路使能 | `23 0D 20 01 00 00 00 00` | 启动 A 路电机 |
| B 路使能 | `23 0D 20 02 00 00 00 00` | 启动 B 路电机 |
| A 路失能 | `23 0C 20 01 00 00 00 00` | 停止 A 路电机 |
| B 路失能 | `23 0C 20 02 00 00 00 00` | 停止 B 路电机 |

**返回帧：**
- ID: `0x580000 + 驱动器地址`
- 数据: `60 0D 20 00 00 00 00 00`（成功应答）

---

### 2️⃣ 速度设定命令

| 功能 | 指令 | 数据说明 |
|------|------|-----------|
| A 路速度设定 | `23 00 20 01 DATA_H DATA_H DATA_L DATA_L` | -10000 ~ +10000 |
| B 路速度设定 | `23 00 20 02 DATA_H DATA_H DATA_L DATA_L` | -10000 ~ +10000 |

- **正值**：逆时针转动（正转）  
- **负值**：顺时针转动（反转）  
- **对应关系**：-10000 → 负额定转速，+10000 → 正额定转速  

示例：
```text
速度设定 300rpm（额定转速 3000rpm）：23 00 20 01 00 00 03 E8
速度设定 -300rpm：23 00 20 01 FF FF FC 18
```

---

### 3️⃣ 转矩设定命令

| 功能 | 指令 |
|------|------|
| A 路转矩 | `23 01 20 01 DATA_H DATA_H DATA_L DATA_L` |
| B 路转矩 | `23 01 20 02 DATA_H DATA_H DATA_L DATA_L` |

返回帧：`60 01 20 00 00 00 00 00`

---

### 4️⃣ 位置设定命令

| 功能 | 指令 |
|------|------|
| A 路位置设定 | `23 02 20 01 DATA_H DATA_H DATA_L DATA_L` |
| B 路位置设定 | `23 02 20 02 DATA_H DATA_H DATA_L DATA_L` |

- 位置范围：`-10000 ~ +10000`（对应反转 360° ~ 正转 360°）
- 返回帧：`60 02 20 00 00 00 00 00`

⚠️ **注意：** 连续发送两条指令间隔不得超过 1000ms，否则驱动器报错并需重新使能。

---

## 三、查询命令

| 功能 | 发送指令 | 返回数据说明 |
|------|------------|----------------|
| 电机电流 | `40 00 21 01 00 00 00 00` | A/B路电流值（16位无符号，单位A） |
| 故障码 | `40 12 21 01 00 00 00 00` | 返回故障标志位（需转二进制解析） |
| 转速 | `40 03 21 01 00 00 00 00` | 返回当前转速（16进制→10进制） |
| 母线电压 | `40 0D 21 02 00 00 00 00` | 返回母线电压（单位V） |
| 温度 | `40 0F 21 01 00 00 00 00` | 驱动器 / A路 / B路温度 |
| 机械位置 | `40 04 21 02 00 00 00 00` | ±2³¹ 脉冲计数（绝对位置模式） |
| 软件版本 | `40 01 11 11 00 00 00 00` | 返回版本号（如 20210915） |

**返回帧格式：**
```text
60 XX 21 XX DATA_H DATA_L DATB_H DATB_L
```
> A 路和 B 路各占 2 字节。

---

## 四、心跳数据格式

心跳包由驱动器自动发送，每秒一次：

| 项目 | 内容 |
|------|------|
| **发送 ID** | `0x700000 + 驱动器地址` |
| **数据长度** | 8 字节 |
| **数据内容** | A路转速、B路转速、A/B电角度 |

示例：
```text
[ID: 0x700001]  DATA: A_SPD_H A_SPD_L B_SPD_H B_SPD_L A_ANG_H A_ANG_L B_ANG_H B_ANG_L
```

---

## 五、CAN 总线控制示例

| 功能 | 示例 |
|------|------|
| **A 路正转 300rpm** | `23 0D 20 01 00 00 00 00`<br>`23 00 20 01 00 00 03 E8` |
| **A 路反转 300rpm** | `23 0D 20 01 00 00 00 00`<br>`23 00 20 01 FF FF FC 18` |
| **查询电流** | `40 00 21 01 00 00 00 00` |
| **查询故障** | `40 12 21 01 00 00 00 00` |

**反馈 ID：** `0x580000 + 驱动器地址`

**注意事项：**
- 指令周期 ≤ 1s
- 每次修改后应验证应答帧
- 多设备使用时，每台驱动器应设置唯一地址（通过上位机18号参数）

---

## 六、故障码解析规则

- 故障返回为 16 进制，需要转换为二进制读取。
- 从右往左第 n 位为 1 表示对应故障：
  - 位1：失能
  - 位5：欠压
  - 位12：转子位置传感器故障

示例：
```text
反馈：60 12 21 01 00 11 08 11
A 路故障：00 11 → 二进制 0000 0000 0001 0001 → 位1+5 故障（失能、欠压）
B 路故障：08 11 → 二进制 0000 1000 0001 0001 → 位1+5+12 故障
```

---

## 七、开发者建议

- 推荐在上位机软件中实现 **周期性心跳监测**。
- 对所有命令执行后读取反馈帧确认状态。
- 对控制帧和查询帧分别维护发送缓存，防止看门狗超时。
- 通过上位机设置唯一 **CAN ID** 以避免地址冲突。

---

✅ **总结**：
LKBLS481502 的 CAN 协议兼容 **CANopen 查询模式**，采用固定的 SDO 命令结构，支持电机 **使能/失能、速度、位置、转矩控制** 及实时数据反馈，适用于双通道同步控制系统的上位机或嵌入式开发环境。

