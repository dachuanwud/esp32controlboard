# ğŸš€ ESP32æ§åˆ¶æ¿Web OTAç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•éƒ¨ç½²ESP32æ§åˆ¶æ¿Web OTAç³»ç»Ÿï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒé…ç½®ã€å›ºä»¶ç¼–è¯‘ã€Webå‰ç«¯æ„å»ºã€è®¾å¤‡çƒ§å½•å’Œç³»ç»Ÿæµ‹è¯•ç­‰å®Œæ•´æµç¨‹ã€‚

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

### ç¡¬ä»¶è¦æ±‚

- **ESP32å¼€å‘æ¿**: æ”¯æŒWi-FiåŠŸèƒ½çš„ESP32èŠ¯ç‰‡
- **USBæ•°æ®çº¿**: Type-Cæˆ–Micro-USB (æ ¹æ®å¼€å‘æ¿æ¥å£)
- **ç”µè„‘**: Windows 10/11, macOS, æˆ– Linux
- **ç½‘ç»œç¯å¢ƒ**: 2.4GHz Wi-Fiç½‘ç»œ

### è½¯ä»¶ç¯å¢ƒ

#### ESP-IDFå¼€å‘ç¯å¢ƒ

1. **å®‰è£…ESP-IDF**
   ```bash
   # ä¸‹è½½ESP-IDF v5.4.1
   git clone -b v5.4.1 --recursive https://github.com/espressif/esp-idf.git
   
   # å®‰è£…ä¾èµ–
   cd esp-idf
   ./install.sh  # Linux/macOS
   install.bat   # Windows
   ```

2. **è®¾ç½®ç¯å¢ƒå˜é‡**
   ```bash
   # Linux/macOS
   . $HOME/esp/esp-idf/export.sh
   
   # Windows
   %userprofile%\esp\esp-idf\export.bat
   ```

#### Node.jså¼€å‘ç¯å¢ƒ

1. **å®‰è£…Node.js**
   - è®¿é—® [Node.jså®˜ç½‘](https://nodejs.org/)
   - ä¸‹è½½å¹¶å®‰è£…LTSç‰ˆæœ¬ (æ¨è18.xæˆ–æ›´é«˜ç‰ˆæœ¬)

2. **éªŒè¯å®‰è£…**
   ```bash
   node --version  # åº”æ˜¾ç¤ºv18.x.xæˆ–æ›´é«˜
   npm --version   # åº”æ˜¾ç¤ºnpmç‰ˆæœ¬
   ```

## ğŸ“¦ é¡¹ç›®æ„å»º

### æ–¹æ³•ä¸€ï¼šä¸€é”®æ„å»º (æ¨è)

ä½¿ç”¨æä¾›çš„æ‰¹å¤„ç†è„šæœ¬è¿›è¡Œå®Œæ•´æ„å»ºï¼š

```bash
# Windows
build_all_ota.bat

# è¯¥è„šæœ¬å°†è‡ªåŠ¨å®Œæˆï¼š
# 1. ESP32å›ºä»¶ç¼–è¯‘
# 2. Webå‰ç«¯æ„å»º
# 3. æ˜¾ç¤ºæ„å»ºç»“æœ
```

### æ–¹æ³•äºŒï¼šåˆ†æ­¥æ„å»º

#### 1. ESP32å›ºä»¶æ„å»º

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd esp32controlboard

# é…ç½®é¡¹ç›® (å¯é€‰)
idf.py menuconfig

# ç¼–è¯‘å›ºä»¶
idf.py build

# æˆ–ä½¿ç”¨æä¾›çš„è„šæœ¬
build_only.bat
```

**æ„å»ºè¾“å‡ºæ–‡ä»¶:**
- `build/esp32controlboard.bin` - ä¸»åº”ç”¨ç¨‹åº
- `build/bootloader/bootloader.bin` - å¼•å¯¼ç¨‹åº
- `build/partition_table/partition-table.bin` - åˆ†åŒºè¡¨

#### 2. Webå‰ç«¯æ„å»º

```bash
# è¿›å…¥Webå®¢æˆ·ç«¯ç›®å½•
cd web_client

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# æˆ–ä½¿ç”¨æä¾›çš„è„šæœ¬
cd ..
build_web.bat
```

**æ„å»ºè¾“å‡ºæ–‡ä»¶:**
- `web_client/dist/` - ç”Ÿäº§ç‰ˆæœ¬æ–‡ä»¶
- `web_client/dist/index.html` - ä¸»é¡µé¢
- `web_client/dist/assets/` - é™æ€èµ„æº

## ğŸ”§ è®¾å¤‡é…ç½®

### 1. ç¡¬ä»¶è¿æ¥

1. **è¿æ¥ESP32åˆ°ç”µè„‘**
   - ä½¿ç”¨USBæ•°æ®çº¿è¿æ¥ESP32å¼€å‘æ¿
   - ç¡®è®¤è®¾å¤‡ç®¡ç†å™¨ä¸­å‡ºç°COMç«¯å£

2. **æ£€æŸ¥ç«¯å£å·**
   ```bash
   # Windows
   # æŸ¥çœ‹è®¾å¤‡ç®¡ç†å™¨ä¸­çš„COMç«¯å£å·
   
   # Linux/macOS
   ls /dev/tty*
   ```

### 2. å›ºä»¶çƒ§å½•

#### é¦–æ¬¡çƒ§å½• (å®Œæ•´çƒ§å½•)

```bash
# ä½¿ç”¨æä¾›çš„è„šæœ¬ (Windows)
flash_com10.bat

# æˆ–æ‰‹åŠ¨çƒ§å½•
idf.py -p COM10 flash

# Linux/macOSç¤ºä¾‹
idf.py -p /dev/ttyUSB0 flash
```

#### ç›‘æ§ä¸²å£è¾“å‡º

```bash
# çƒ§å½•åç›‘æ§è®¾å¤‡å¯åŠ¨
idf.py -p COM10 monitor

# æˆ–ç»„åˆçƒ§å½•å’Œç›‘æ§
idf.py -p COM10 flash monitor
```

### 3. Wi-Fiç½‘ç»œé…ç½®

#### æ–¹æ³•ä¸€ï¼šç¡¬ç¼–ç é…ç½® (æ¨èç”¨äºæµ‹è¯•)

ä¿®æ”¹ `main/main.c` æ–‡ä»¶ä¸­çš„Wi-Fié…ç½®ï¼š

```c
// Wi-Fié…ç½® - ä¿®æ”¹ä¸ºæ‚¨çš„ç½‘ç»œä¿¡æ¯
#define DEFAULT_WIFI_SSID     "æ‚¨çš„WiFiåç§°"
#define DEFAULT_WIFI_PASSWORD "æ‚¨çš„WiFiå¯†ç "
```

é‡æ–°ç¼–è¯‘å¹¶çƒ§å½•å›ºä»¶ã€‚

#### æ–¹æ³•äºŒï¼šWebç•Œé¢é…ç½®

1. ESP32é¦–æ¬¡å¯åŠ¨æ—¶ä¼šåˆ›å»ºçƒ­ç‚¹
2. è¿æ¥åˆ°ESP32çƒ­ç‚¹
3. é€šè¿‡Webç•Œé¢é…ç½®Wi-Fiç½‘ç»œ

## ğŸŒ Webå‰ç«¯éƒ¨ç½²

### æ–¹æ³•ä¸€ï¼šæœ¬åœ°å¼€å‘æœåŠ¡å™¨

```bash
cd web_client

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# è®¿é—® http://localhost:3000
```

### æ–¹æ³•äºŒï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### ä½¿ç”¨Nginx

1. **å®‰è£…Nginx**
   ```bash
   # Ubuntu/Debian
   sudo apt install nginx
   
   # CentOS/RHEL
   sudo yum install nginx
   ```

2. **é…ç½®Nginx**
   ```nginx
   server {
       listen 80;
       server_name localhost;
       
       location / {
           root /path/to/web_client/dist;
           index index.html;
           try_files $uri $uri/ /index.html;
       }
       
       location /api/ {
           proxy_pass http://192.168.1.100/api/;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
   }
   ```

3. **å¯åŠ¨æœåŠ¡**
   ```bash
   sudo systemctl start nginx
   sudo systemctl enable nginx
   ```

#### ä½¿ç”¨Apache

1. **å®‰è£…Apache**
   ```bash
   # Ubuntu/Debian
   sudo apt install apache2
   
   # CentOS/RHEL
   sudo yum install httpd
   ```

2. **é…ç½®è™šæ‹Ÿä¸»æœº**
   ```apache
   <VirtualHost *:80>
       DocumentRoot /path/to/web_client/dist
       
       ProxyPass /api/ http://192.168.1.100/api/
       ProxyPassReverse /api/ http://192.168.1.100/api/
   </VirtualHost>
   ```

## ğŸ” ç³»ç»Ÿæµ‹è¯•

### 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•

#### ESP32è®¾å¤‡æµ‹è¯•

1. **ä¸²å£ç›‘æ§**
   ```bash
   idf.py -p COM10 monitor
   ```
   
   æ£€æŸ¥è¾“å‡ºæ—¥å¿—ï¼š
   - âœ… Wi-Fiè¿æ¥æˆåŠŸ
   - âœ… HTTPæœåŠ¡å™¨å¯åŠ¨
   - âœ… OTAç®¡ç†å™¨åˆå§‹åŒ–

2. **ç½‘ç»œè¿æ¥æµ‹è¯•**
   ```bash
   # æŸ¥æ‰¾ESP32è®¾å¤‡IP
   ping 192.168.1.100
   
   # æµ‹è¯•HTTPæœåŠ¡
   curl http://192.168.1.100/api/device/info
   ```

#### Webç•Œé¢æµ‹è¯•

1. **è®¿é—®Webç•Œé¢**
   - æµè§ˆå™¨æ‰“å¼€: `http://[ESP32_IP]`
   - æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£å¸¸åŠ è½½

2. **åŠŸèƒ½æµ‹è¯•æ¸…å•**
   - [ ] è®¾å¤‡ä¿¡æ¯é¡µé¢æ˜¾ç¤ºæ­£å¸¸
   - [ ] å®æ—¶çŠ¶æ€æ•°æ®æ›´æ–°
   - [ ] SBUSé€šé“æ•°æ®æ˜¾ç¤º (å¦‚å·²è¿æ¥)
   - [ ] Wi-FiçŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
   - [ ] OTAä¸Šä¼ ç•Œé¢å¯ç”¨

### 2. OTAæ›´æ–°æµ‹è¯•

#### å‡†å¤‡æµ‹è¯•å›ºä»¶

1. **ä¿®æ”¹å›ºä»¶ç‰ˆæœ¬å·**
   ```c
   // åœ¨main.cä¸­ä¿®æ”¹ç‰ˆæœ¬ä¿¡æ¯
   strcpy(info->firmware_version, "1.0.1-OTA-TEST");
   ```

2. **é‡æ–°ç¼–è¯‘**
   ```bash
   idf.py build
   ```

#### æ‰§è¡ŒOTAæµ‹è¯•

1. **é€šè¿‡Webç•Œé¢ä¸Šä¼ å›ºä»¶**
   - é€‰æ‹© `build/esp32controlboard.bin` æ–‡ä»¶
   - ç‚¹å‡»"å¼€å§‹æ›´æ–°"
   - ç›‘æ§æ›´æ–°è¿›åº¦

2. **éªŒè¯æ›´æ–°ç»“æœ**
   - è®¾å¤‡è‡ªåŠ¨é‡å¯
   - æ£€æŸ¥æ–°ç‰ˆæœ¬å·
   - éªŒè¯åŠŸèƒ½æ­£å¸¸

### 3. å‹åŠ›æµ‹è¯•

#### ç½‘ç»œç¨³å®šæ€§æµ‹è¯•

```bash
# æŒç»­pingæµ‹è¯•
ping -t 192.168.1.100

# APIæ¥å£å‹åŠ›æµ‹è¯•
for i in {1..100}; do
  curl http://192.168.1.100/api/device/status
  sleep 1
done
```

#### å†…å­˜æ³„æ¼æµ‹è¯•

ç›‘æ§ESP32è®¾å¤‡çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼š

```bash
# æŒç»­ç›‘æ§ä¸²å£è¾“å‡ºä¸­çš„å†…å­˜ä¿¡æ¯
idf.py -p COM10 monitor | grep -i "heap\|memory"
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. ç¼–è¯‘é”™è¯¯

**é—®é¢˜**: ESP-IDFç¼–è¯‘å¤±è´¥
```
è§£å†³æ–¹æ¡ˆ:
1. æ£€æŸ¥ESP-IDFç‰ˆæœ¬ (æ¨èv5.4.1)
2. ç¡®è®¤ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
3. æ¸…ç†æ„å»ºç¼“å­˜: idf.py fullclean
4. é‡æ–°å®‰è£…ESP-IDFä¾èµ–
```

**é—®é¢˜**: Webå‰ç«¯æ„å»ºå¤±è´¥
```
è§£å†³æ–¹æ¡ˆ:
1. æ£€æŸ¥Node.jsç‰ˆæœ¬ (éœ€è¦18+)
2. æ¸…ç†node_modules: rm -rf node_modules package-lock.json
3. é‡æ–°å®‰è£…ä¾èµ–: npm install
4. æ£€æŸ¥TypeScripté”™è¯¯
```

#### 2. çƒ§å½•é—®é¢˜

**é—®é¢˜**: æ— æ³•è¿æ¥åˆ°ESP32
```
è§£å†³æ–¹æ¡ˆ:
1. æ£€æŸ¥USBæ•°æ®çº¿è¿æ¥
2. ç¡®è®¤COMç«¯å£å·æ­£ç¡®
3. æ£€æŸ¥é©±åŠ¨ç¨‹åºå®‰è£…
4. å°è¯•æŒ‰ä½BOOTæŒ‰é’®çƒ§å½•
```

**é—®é¢˜**: çƒ§å½•å¤±è´¥
```
è§£å†³æ–¹æ¡ˆ:
1. é™ä½çƒ§å½•æ³¢ç‰¹ç‡: idf.py -p COM10 -b 115200 flash
2. æ£€æŸ¥Flashå¤§å°é…ç½®
3. å°è¯•æ“¦é™¤Flash: idf.py -p COM10 erase_flash
```

#### 3. ç½‘ç»œè¿æ¥é—®é¢˜

**é—®é¢˜**: Wi-Fiè¿æ¥å¤±è´¥
```
è§£å†³æ–¹æ¡ˆ:
1. æ£€æŸ¥SSIDå’Œå¯†ç æ­£ç¡®æ€§
2. ç¡®è®¤ç½‘ç»œä¸º2.4GHzé¢‘æ®µ
3. æ£€æŸ¥ç½‘ç»œä¿¡å·å¼ºåº¦
4. æŸ¥çœ‹ESP32ä¸²å£æ—¥å¿—
```

**é—®é¢˜**: æ— æ³•è®¿é—®Webç•Œé¢
```
è§£å†³æ–¹æ¡ˆ:
1. ç¡®è®¤ESP32è·å¾—IPåœ°å€
2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
3. å°è¯•ç›´æ¥è®¿é—®API: curl http://[IP]/api/device/info
4. æ£€æŸ¥HTTPæœåŠ¡å™¨çŠ¶æ€
```

#### 4. OTAæ›´æ–°é—®é¢˜

**é—®é¢˜**: OTAæ›´æ–°å¤±è´¥
```
è§£å†³æ–¹æ¡ˆ:
1. æ£€æŸ¥å›ºä»¶æ–‡ä»¶æ ¼å¼ (.bin)
2. ç¡®è®¤æ–‡ä»¶å¤§å° (â‰¤1MB)
3. æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§
4. æŸ¥çœ‹OTAé”™è¯¯æ—¥å¿—
```

**é—®é¢˜**: æ›´æ–°åè®¾å¤‡æ— æ³•å¯åŠ¨
```
è§£å†³æ–¹æ¡ˆ:
1. ç­‰å¾…è‡ªåŠ¨å›æ»š (30ç§’)
2. æ‰‹åŠ¨å›æ»š: è®¿é—® /api/ota/rollback
3. é‡æ–°çƒ§å½•åŸå§‹å›ºä»¶
4. æ£€æŸ¥åˆ†åŒºè¡¨é…ç½®
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

### ç³»ç»Ÿèµ„æºç›‘æ§

#### ESP32ç«¯ç›‘æ§

```c
// åœ¨ä»£ç ä¸­æ·»åŠ ç›‘æ§æ—¥å¿—
ESP_LOGI(TAG, "Free heap: %d bytes", esp_get_free_heap_size());
ESP_LOGI(TAG, "Min free heap: %d bytes", esp_get_minimum_free_heap_size());
```

#### ç½‘ç»œæ€§èƒ½ç›‘æ§

```bash
# ç›‘æ§ç½‘ç»œå»¶è¿Ÿ
ping -c 100 192.168.1.100

# ç›‘æ§HTTPå“åº”æ—¶é—´
curl -w "@curl-format.txt" -o /dev/null -s http://192.168.1.100/api/device/info
```

### æ—¥å¿—åˆ†æ

#### ESP32æ—¥å¿—çº§åˆ«é…ç½®

```bash
# è®¾ç½®æ—¥å¿—çº§åˆ«
idf.py menuconfig
# Component config -> Log output -> Default log verbosity
```

#### WebæœåŠ¡å™¨è®¿é—®æ—¥å¿—

åœ¨HTTPæœåŠ¡å™¨ä»£ç ä¸­æ·»åŠ è®¿é—®æ—¥å¿—ï¼š

```c
ESP_LOGI(TAG, "API Request: %s %s from %s", 
         httpd_req_get_method(req), 
         req->uri, 
         "client_ip");
```

## ğŸ”„ ç»´æŠ¤å’Œæ›´æ–°

### å®šæœŸç»´æŠ¤ä»»åŠ¡

1. **å›ºä»¶æ›´æ–°**
   - å®šæœŸæ£€æŸ¥æ–°ç‰ˆæœ¬
   - æµ‹è¯•OTAæ›´æ–°æµç¨‹
   - å¤‡ä»½å½“å‰é…ç½®

2. **ç³»ç»Ÿç›‘æ§**
   - æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
   - ç›‘æ§ç½‘ç»œè¿æ¥ç¨³å®šæ€§
   - åˆ†æé”™è¯¯æ—¥å¿—

3. **å®‰å…¨æ›´æ–°**
   - æ›´æ–°Wi-Fiå¯†ç 
   - æ£€æŸ¥è®¿é—®æ§åˆ¶
   - å®¡æŸ¥APIå®‰å…¨æ€§

### ç‰ˆæœ¬ç®¡ç†

#### å›ºä»¶ç‰ˆæœ¬ç®¡ç†

```c
// ç‰ˆæœ¬å·æ ¼å¼: MAJOR.MINOR.PATCH-TYPE
#define FIRMWARE_VERSION "1.0.0-OTA"
```

#### Webå‰ç«¯ç‰ˆæœ¬ç®¡ç†

```json
{
  "version": "1.0.0",
  "build": "20240101-001"
}
```

---

*æœ¬éƒ¨ç½²æŒ‡å—åŸºäºESP32æ§åˆ¶æ¿Web OTAç³»ç»Ÿv1.0.0ï¼Œå¦‚é‡é—®é¢˜è¯·å‚è€ƒæ•…éšœæ’é™¤ç« èŠ‚æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚*
