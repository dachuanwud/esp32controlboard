# 🔧 ESP32控制板设备管理指南

## 📋 概述

本指南将详细介绍如何使用ESP32控制板Web上位机的设备管理功能，包括设备发现、添加、管理和连接真实的ESP32硬件设备。

## 🚀 快速开始

### 1. 启动应用

```bash
cd web_client
npm install
npm run dev
```

访问 `http://localhost:5173` 打开Web界面。

### 2. 首次使用

当您首次打开应用时，会看到欢迎界面，提示您添加ESP32设备。

## 🔍 设备发现和添加

### 方法一：自动发现设备

1. **打开设备管理**
   - 点击导航栏中的设备选择器
   - 选择"🔧 设备管理"

2. **快速发现**
   - 在设备管理对话框中，切换到"🔍 设备发现"标签
   - 点击"⚡ 快速发现"按钮
   - 系统将扫描常用IP地址段，寻找ESP32设备

3. **全网段扫描**
   - 输入您的网络IP段（如：192.168.1）
   - 点击"🌐 全网段扫描"
   - 系统将扫描该网段下的所有IP地址（1-254）

4. **添加发现的设备**
   - 在发现结果中，点击设备旁边的"➕ 添加"按钮
   - 设备将自动添加到设备列表中

### 方法二：手动添加设备

1. **打开设备管理**
   - 点击导航栏中的设备选择器
   - 选择"🔧 设备管理"

2. **手动添加**
   - 在"➕ 手动添加"标签中
   - 输入设备名称（如：ESP32控制板-001）
   - 输入设备IP地址（如：192.168.1.100）
   - 点击"➕ 添加设备"

3. **连接测试**
   - 系统将自动测试与设备的连接
   - 连接成功后，设备将添加到列表中

## ⚙️ 设备管理

### 查看设备列表

在设备管理对话框的"⚙️ 设备管理"标签中，您可以看到所有已添加的设备：

- **设备状态**：在线/离线状态指示器
- **设备信息**：名称、IP地址、最后连接时间
- **操作按钮**：测试、编辑、删除

### 编辑设备信息

1. 点击设备旁边的"✏️ 编辑"按钮
2. 修改设备名称或IP地址
3. 点击"💾 保存"确认更改
4. 如果IP地址发生变化，系统会自动测试新的连接

### 测试设备连接

1. 点击设备旁边的"🔍 测试"按钮
2. 系统将尝试连接设备并更新状态
3. 连接结果会显示在状态指示器中

### 删除设备

1. 点击设备旁边的"🗑️ 删除"按钮
2. 确认删除操作
3. 设备将从列表中移除

## 🎯 设备选择和切换

### 选择当前设备

1. 点击导航栏中的设备选择器
2. 从下拉列表中选择要使用的设备
3. 当前选中的设备会在页面标题中显示

### 设备状态指示

- **🟢 绿色圆点**：设备在线
- **🔴 红色圆点**：设备离线
- **🟡 黄色圆点**：连接检查中

### 刷新设备状态

1. 点击设备选择器下拉菜单
2. 选择"🔄 刷新状态"
3. 系统将检查所有设备的连接状态

## 📊 真实设备连接

### ESP32设备要求

确保您的ESP32设备满足以下条件：

1. **网络连接**
   - ESP32已连接到与电脑相同的网络
   - 设备具有固定或已知的IP地址

2. **HTTP服务器**
   - ESP32运行HTTP服务器
   - 提供标准的API端点：
     - `/api/device/info` - 设备信息
     - `/api/device/status` - 设备状态
     - `/api/ota/upload` - OTA更新
     - `/api/wifi/status` - Wi-Fi状态

3. **API响应格式**
   ```json
   {
     "status": "success",
     "data": { ... },
     "message": "操作成功"
   }
   ```

### 网络配置

1. **查找ESP32 IP地址**
   - 通过串口监视器查看ESP32的IP地址
   - 使用网络扫描工具查找设备
   - 检查路由器的DHCP客户端列表

2. **网络连通性测试**
   ```bash
   # 测试网络连通性
   ping 192.168.1.100
   
   # 测试HTTP服务
   curl http://192.168.1.100/api/device/info
   ```

### 常见连接问题

1. **设备无法发现**
   - 检查ESP32是否已连接到网络
   - 确认IP地址是否正确
   - 检查防火墙设置

2. **连接超时**
   - 检查网络延迟
   - 确认ESP32的HTTP服务是否正常运行
   - 尝试增加连接超时时间

3. **API调用失败**
   - 检查ESP32的API端点是否正确实现
   - 确认响应格式是否符合要求
   - 查看浏览器开发者工具的网络请求

## 💾 数据持久化

### 本地存储

设备信息自动保存到浏览器的localStorage中：

- **设备列表**：所有添加的设备信息
- **选中设备**：当前选择的设备ID
- **最后更新时间**：数据的最后更新时间

### 数据导出和导入

1. **导出设备数据**
   ```javascript
   // 在浏览器控制台中执行
   const data = DeviceStorageService.exportDevices()
   console.log(data)
   ```

2. **导入设备数据**
   ```javascript
   // 在浏览器控制台中执行
   const success = DeviceStorageService.importDevices(jsonData)
   console.log('导入结果:', success)
   ```

### 清除数据

如需清除所有设备数据：

```javascript
// 在浏览器控制台中执行
DeviceStorageService.clearAll()
```

## 🔧 高级功能

### 批量设备管理

1. **批量添加设备**
   - 使用全网段扫描功能
   - 一次性发现并添加多个设备

2. **批量状态检查**
   - 定期自动检查所有设备状态
   - 手动刷新所有设备状态

### 设备分组

虽然当前版本不支持设备分组，但您可以通过命名约定来组织设备：

- `ESP32-车间1-001`
- `ESP32-车间1-002`
- `ESP32-车间2-001`

### API实例管理

系统会为每个设备创建独立的API实例：

- 自动路由API调用到正确的设备IP
- 独立的超时和错误处理
- 支持并发访问多个设备

## 🚨 故障排除

### 常见问题

1. **设备列表为空**
   - 检查localStorage是否被清除
   - 尝试重新添加设备

2. **设备显示离线**
   - 检查ESP32是否正常运行
   - 测试网络连接
   - 检查IP地址是否发生变化

3. **API调用失败**
   - 检查ESP32的HTTP服务状态
   - 确认API端点实现正确
   - 查看浏览器控制台错误信息

### 调试技巧

1. **启用详细日志**
   ```javascript
   // 在浏览器控制台中启用调试
   localStorage.setItem('debug', 'true')
   ```

2. **查看存储状态**
   ```javascript
   // 查看设备存储统计
   const stats = DeviceStorageService.getStorageStats()
   console.log('存储统计:', stats)
   ```

3. **网络请求监控**
   - 打开浏览器开发者工具
   - 切换到"网络"标签
   - 监控API请求和响应

## 📈 性能优化

### 连接优化

1. **减少扫描范围**
   - 使用快速发现而非全网段扫描
   - 指定准确的IP网段

2. **调整刷新频率**
   - 根据需要调整自动刷新间隔
   - 在不需要时关闭自动刷新

3. **缓存设备信息**
   - 系统自动缓存设备信息
   - 减少不必要的API调用

## 🎯 最佳实践

1. **设备命名**
   - 使用有意义的设备名称
   - 包含位置或功能信息

2. **网络规划**
   - 为ESP32设备分配固定IP
   - 使用专用的网段

3. **定期维护**
   - 定期检查设备状态
   - 及时更新离线设备信息

4. **备份配置**
   - 定期导出设备配置
   - 保存重要的设备信息

通过以上指南，您可以充分利用ESP32控制板Web上位机的设备管理功能，实现对真实ESP32硬件设备的有效管理和控制。
