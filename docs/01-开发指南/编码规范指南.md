# ðŸ“ ç¼–ç è§„èŒƒæŒ‡å—

æœ¬æŒ‡å—å®šä¹‰äº†ESP32æŽ§åˆ¶æ¿é¡¹ç›®çš„ç¼–ç æ ‡å‡†å’Œè§„èŒƒï¼Œç¡®ä¿ä»£ç è´¨é‡ã€å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## ðŸŽ¯ è§„èŒƒç›®æ ‡

- âœ… æé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
- âœ… ç»Ÿä¸€å›¢é˜Ÿç¼–ç é£Žæ ¼
- âœ… å‡å°‘ä»£ç å®¡æŸ¥æ—¶é—´
- âœ… é™ä½ŽBugå‘ç”ŸçŽ‡
- âœ… ä¾¿äºŽæ–°æˆå‘˜å¿«é€Ÿä¸Šæ‰‹

## ðŸ“‹ è§„èŒƒæ¦‚è§ˆ

### æ ¸å¿ƒåŽŸåˆ™
1. **ä¸€è‡´æ€§**: æ•´ä¸ªé¡¹ç›®ä¿æŒç»Ÿä¸€çš„ç¼–ç é£Žæ ¼
2. **å¯è¯»æ€§**: ä»£ç åº”è¯¥æ˜“äºŽç†è§£å’Œç»´æŠ¤
3. **ç®€æ´æ€§**: é¿å…ä¸å¿…è¦çš„å¤æ‚æ€§
4. **å®‰å…¨æ€§**: éµå¾ªå®‰å…¨ç¼–ç¨‹å®žè·µ

## ðŸ”¤ å‘½åè§„èŒƒ

### æ–‡ä»¶å‘½å
```c
// æºæ–‡ä»¶ï¼šå°å†™å­—æ¯ + ä¸‹åˆ’çº¿
main.c
sbus.c
wifi_manager.c
http_server.c

// å¤´æ–‡ä»¶ï¼šä¸Žæºæ–‡ä»¶å¯¹åº”
main.h
sbus.h
wifi_manager.h
http_server.h

// é©±åŠ¨æ–‡ä»¶ï¼šdrv_ å‰ç¼€
drv_keyadouble.c
drv_keyadouble.h

// å·¥å…·æ–‡ä»¶ï¼šutil_ å‰ç¼€
util_string.c
util_math.h
```

### å‡½æ•°å‘½å
```c
// æ¨¡å—åˆå§‹åŒ–ï¼šmodule_init
esp_err_t sbus_init(void);
esp_err_t wifi_manager_init(void);

// å…¬å…±æŽ¥å£ï¼šmodule_action
esp_err_t sbus_get_data(uint8_t* data);
bool wifi_manager_is_connected(void);

// ç§æœ‰å‡½æ•°ï¼šstatic + æ¨¡å—å‰ç¼€
static void sbus_parse_frame(uint8_t* frame);
static esp_err_t wifi_connect_internal(void);

// ä¸­æ–­å¤„ç†ï¼šIRAM_ATTR + _isr_handler åŽç¼€
void IRAM_ATTR sbus_uart_isr_handler(void* arg);
void IRAM_ATTR timer_isr_handler(void* arg);
```

### å˜é‡å‘½å
```c
// å…¨å±€å˜é‡ï¼šg_ å‰ç¼€
static uint32_t g_sbus_frame_count;
static bool g_wifi_connected;

// å±€éƒ¨å˜é‡ï¼šå°å†™å­—æ¯ + ä¸‹åˆ’çº¿
int channel_value;
uint8_t buffer_index;
esp_err_t ret_code;

// å¸¸é‡ï¼šå¤§å†™å­—æ¯ + ä¸‹åˆ’çº¿
#define MAX_BUFFER_SIZE     1024
#define SBUS_FRAME_LENGTH   25
#define WIFI_RETRY_COUNT    5

// æžšä¸¾ï¼šç±»åž‹å_VALUE
typedef enum {
    WIFI_STATE_DISCONNECTED,
    WIFI_STATE_CONNECTING,
    WIFI_STATE_CONNECTED,
    WIFI_STATE_FAILED
} wifi_state_t;
```

### ç»“æž„ä½“å‘½å
```c
// ç»“æž„ä½“ç±»åž‹ï¼š_t åŽç¼€
typedef struct {
    uint16_t channel[16];
    uint32_t timestamp;
    bool valid;
} sbus_data_t;

typedef struct {
    char ssid[32];
    char password[64];
    uint8_t retry_count;
} wifi_config_t;

// ç»“æž„ä½“æˆå‘˜ï¼šå°å†™å­—æ¯ + ä¸‹åˆ’çº¿
typedef struct {
    bool is_connected;
    int signal_strength;
    char ip_address[16];
    uint32_t last_update;
} wifi_status_t;
```

## ðŸ“ ä»£ç æ ¼å¼

### ç¼©è¿›å’Œç©ºæ ¼
```c
// ä½¿ç”¨4ä¸ªç©ºæ ¼ç¼©è¿›ï¼Œä¸ä½¿ç”¨Tab
void function_example(void)
{
    if (condition) {
        // 4ä¸ªç©ºæ ¼ç¼©è¿›
        do_something();
        
        if (another_condition) {
            // 8ä¸ªç©ºæ ¼ç¼©è¿›
            do_another_thing();
        }
    }
}

// è¿ç®—ç¬¦å‰åŽåŠ ç©ºæ ¼
int result = a + b * c;
bool flag = (value > 0) && (value < 100);

// é€—å·åŽåŠ ç©ºæ ¼
function_call(param1, param2, param3);
```

### å¤§æ‹¬å·é£Žæ ¼
```c
// å‡½æ•°ï¼šå¤§æ‹¬å·å¦èµ·ä¸€è¡Œ
void function_name(void)
{
    // å‡½æ•°ä½“
}

// æŽ§åˆ¶ç»“æž„ï¼šå¤§æ‹¬å·è·Ÿéš
if (condition) {
    // ä»£ç å—
} else if (other_condition) {
    // ä»£ç å—
} else {
    // ä»£ç å—
}

// å¾ªçŽ¯ç»“æž„
for (int i = 0; i < count; i++) {
    // å¾ªçŽ¯ä½“
}

while (condition) {
    // å¾ªçŽ¯ä½“
}
```

### è¡Œé•¿åº¦é™åˆ¶
```c
// æ¯è¡Œä¸è¶…è¿‡100ä¸ªå­—ç¬¦
// é•¿è¡Œéœ€è¦æ¢è¡Œ
esp_err_t very_long_function_name(int parameter1, 
                                  int parameter2,
                                  int parameter3)
{
    // å‡½æ•°å®žçŽ°
}

// é•¿å­—ç¬¦ä¸²æ¢è¡Œ
ESP_LOGI(TAG, "This is a very long log message that needs to be "
              "split across multiple lines for better readability");
```

## ðŸ“ æ³¨é‡Šè§„èŒƒ

### æ–‡ä»¶å¤´æ³¨é‡Š
```c
/**
 * @file sbus.c
 * @brief SBUSåè®®æŽ¥æ”¶å’Œè§£æžæ¨¡å—
 * 
 * æœ¬æ¨¡å—å®žçŽ°SBUSåè®®çš„æŽ¥æ”¶ã€è§£æžå’Œæ•°æ®å¤„ç†åŠŸèƒ½ï¼Œ
 * æ”¯æŒæ ‡å‡†SBUSåè®®ï¼ˆ100kbps, 8E2, åç›¸é€»è¾‘ï¼‰ã€‚
 * 
 * @author ESP32æŽ§åˆ¶æ¿å¼€å‘å›¢é˜Ÿ
 * @date 2024-12-19
 * @version 1.0.0
 */
```

### å‡½æ•°æ³¨é‡Š
```c
/**
 * @brief åˆå§‹åŒ–SBUSæŽ¥æ”¶æ¨¡å—
 * 
 * é…ç½®UART2ç”¨äºŽSBUSä¿¡å·æŽ¥æ”¶ï¼Œè®¾ç½®æ³¢ç‰¹çŽ‡ä¸º100000ï¼Œ
 * æ•°æ®æ ¼å¼ä¸º8E2ï¼Œå¹¶å¯ç”¨ä¿¡å·åç›¸åŠŸèƒ½ã€‚
 * 
 * @return esp_err_t 
 *         - ESP_OK: åˆå§‹åŒ–æˆåŠŸ
 *         - ESP_FAIL: åˆå§‹åŒ–å¤±è´¥
 *         - ESP_ERR_INVALID_STATE: æ¨¡å—å·²åˆå§‹åŒ–
 * 
 * @note è°ƒç”¨æ­¤å‡½æ•°å‰éœ€è¦ç¡®ä¿ESP-IDFå·²æ­£ç¡®åˆå§‹åŒ–
 * @warning æ­¤å‡½æ•°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
 */
esp_err_t sbus_init(void);

/**
 * @brief è§£æžSBUSæ•°æ®å¸§
 * 
 * ä»Ž25å­—èŠ‚çš„SBUSæ•°æ®å¸§ä¸­æå–16ä¸ªé€šé“çš„æ•°æ®ï¼Œ
 * æ¯ä¸ªé€šé“ä¸º11ä½ç²¾åº¦ï¼ˆ0-2047èŒƒå›´ï¼‰ã€‚
 * 
 * @param[in] sbus_data SBUSåŽŸå§‹æ•°æ®ï¼ˆ25å­—èŠ‚ï¼‰
 * @param[out] channels è¾“å‡ºçš„é€šé“å€¼æ•°ç»„ï¼ˆ16ä¸ªé€šé“ï¼‰
 * @return uint8_t è§£æžç»“æžœ
 *         - 0: è§£æžæˆåŠŸ
 *         - 1: å¸§å¤´é”™è¯¯
 *         - 2: å¸§å°¾é”™è¯¯
 *         - 3: æ ¡éªŒå¤±è´¥
 */
uint8_t parse_sbus_frame(const uint8_t* sbus_data, uint16_t* channels);
```

### è¡Œå†…æ³¨é‡Š
```c
void sbus_process_task(void *pvParameters)
{
    uint8_t sbus_data[SBUS_FRAME_LENGTH];  // SBUSæ•°æ®ç¼“å†²åŒº
    uint16_t channels[16];                 // é€šé“å€¼æ•°ç»„
    
    while (1) {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„SBUSæ•°æ®
        if (sbus_get_data(sbus_data)) {
            // è§£æžSBUSå¸§å¹¶æå–é€šé“æ•°æ®
            if (parse_sbus_frame(sbus_data, channels) == 0) {
                // å‘é€æ•°æ®åˆ°å¤„ç†é˜Ÿåˆ—
                send_to_queue(channels);
            }
        }
        
        vTaskDelay(pdMS_TO_TICKS(10));  // 10mså»¶æ—¶ï¼Œé¿å…CPUå ç”¨è¿‡é«˜
    }
}
```

## ðŸ”§ é”™è¯¯å¤„ç†

### è¿”å›žå€¼æ£€æŸ¥
```c
// æ€»æ˜¯æ£€æŸ¥å‡½æ•°è¿”å›žå€¼
esp_err_t ret = sbus_init();
if (ret != ESP_OK) {
    ESP_LOGE(TAG, "SBUS initialization failed: %s", esp_err_to_name(ret));
    return ret;
}

// ä½¿ç”¨ESP_ERROR_CHECKå®ï¼ˆä¼šåœ¨é”™è¯¯æ—¶ç»ˆæ­¢ç¨‹åºï¼‰
ESP_ERROR_CHECK(uart_driver_install(UART_NUM_2, 256, 256, 0, NULL, 0));
```

### å‚æ•°éªŒè¯
```c
esp_err_t function_with_params(const char* str, int* value)
{
    // å‚æ•°æœ‰æ•ˆæ€§æ£€æŸ¥
    if (str == NULL || value == NULL) {
        ESP_LOGE(TAG, "Invalid parameters");
        return ESP_ERR_INVALID_ARG;
    }
    
    if (strlen(str) == 0) {
        ESP_LOGW(TAG, "Empty string parameter");
        return ESP_ERR_INVALID_SIZE;
    }
    
    // å‡½æ•°å®žçŽ°
    return ESP_OK;
}
```

### èµ„æºç®¡ç†
```c
esp_err_t allocate_and_process(void)
{
    uint8_t* buffer = NULL;
    esp_err_t ret = ESP_OK;
    
    // åˆ†é…èµ„æº
    buffer = malloc(BUFFER_SIZE);
    if (buffer == NULL) {
        ESP_LOGE(TAG, "Memory allocation failed");
        return ESP_ERR_NO_MEM;
    }
    
    // ä½¿ç”¨èµ„æº
    ret = process_data(buffer);
    if (ret != ESP_OK) {
        ESP_LOGE(TAG, "Data processing failed");
        goto cleanup;
    }
    
cleanup:
    // æ¸…ç†èµ„æº
    if (buffer != NULL) {
        free(buffer);
    }
    
    return ret;
}
```

## ðŸ“Š æ—¥å¿—è§„èŒƒ

### æ—¥å¿—çº§åˆ«ä½¿ç”¨
```c
static const char *TAG = "MODULE_NAME";

// é”™è¯¯ï¼šç³»ç»Ÿæ— æ³•ç»§ç»­è¿è¡Œ
ESP_LOGE(TAG, "âŒ Critical error: %s", esp_err_to_name(err));

// è­¦å‘Šï¼šå¯èƒ½å½±å“åŠŸèƒ½
ESP_LOGW(TAG, "âš ï¸ Warning: buffer nearly full (%d/%d)", used, total);

// ä¿¡æ¯ï¼šé‡è¦çŠ¶æ€å˜åŒ–
ESP_LOGI(TAG, "â„¹ï¸ Module initialized successfully");

// è°ƒè¯•ï¼šè¯¦ç»†è°ƒè¯•ä¿¡æ¯
ESP_LOGD(TAG, "ðŸ” Processing frame: header=0x%02X", frame[0]);

// è¯¦ç»†ï¼šéžå¸¸è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
ESP_LOGV(TAG, "ðŸ“‹ Raw data: %02X %02X %02X", data[0], data[1], data[2]);
```

### æ—¥å¿—æ ¼å¼è§„èŒƒ
```c
// ä½¿ç”¨è¡¨æƒ…ç¬¦å·å¢žå¼ºå¯è¯»æ€§
ESP_LOGI(TAG, "ðŸš€ Starting SBUS receiver...");
ESP_LOGI(TAG, "âœ… SBUS initialization completed");
ESP_LOGI(TAG, "ðŸ“¡ Received %d channels", channel_count);
ESP_LOGI(TAG, "ðŸ”„ Reconnecting to WiFi...");

// åŒ…å«æœ‰ç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
ESP_LOGI(TAG, "ðŸ“Š Performance: %d frames/sec, %d errors", fps, errors);
ESP_LOGI(TAG, "ðŸ’¾ Memory: %d bytes free, %d bytes used", free_mem, used_mem);
```

## ðŸ§ª ä»£ç è´¨é‡

### å‡½æ•°è®¾è®¡åŽŸåˆ™
```c
// å•ä¸€èŒè´£ï¼šæ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹
bool is_sbus_frame_valid(const uint8_t* frame)
{
    return (frame[0] == 0x0F) && (frame[24] == 0x00);
}

void process_sbus_frame(const uint8_t* frame)
{
    if (!is_sbus_frame_valid(frame)) {
        return;
    }
    
    // å¤„ç†æœ‰æ•ˆå¸§
}

// å‡½æ•°é•¿åº¦æŽ§åˆ¶ï¼šä¸è¶…è¿‡50è¡Œ
// å‚æ•°æ•°é‡æŽ§åˆ¶ï¼šä¸è¶…è¿‡5ä¸ªå‚æ•°
esp_err_t configure_uart(uart_port_t port, 
                        int baud_rate, 
                        uart_parity_t parity,
                        uart_stop_bits_t stop_bits,
                        bool invert_rx)
{
    // å®žçŽ°
}
```

### é­”æ³•æ•°å­—é¿å…
```c
// ä¸å¥½çš„åšæ³•
if (data[0] == 0x0F && data[24] == 0x00) {
    // å¤„ç†
}

// å¥½çš„åšæ³•
#define SBUS_FRAME_HEADER   0x0F
#define SBUS_FRAME_FOOTER   0x00
#define SBUS_FRAME_LENGTH   25

if (data[0] == SBUS_FRAME_HEADER && data[SBUS_FRAME_LENGTH-1] == SBUS_FRAME_FOOTER) {
    // å¤„ç†
}
```

## ðŸ” ä»£ç å®¡æŸ¥æ¸…å•

### æäº¤å‰æ£€æŸ¥
- [ ] ä»£ç ç¼–è¯‘æ— è­¦å‘Š
- [ ] å‡½æ•°éƒ½æœ‰é€‚å½“çš„æ³¨é‡Š
- [ ] å˜é‡å‘½åç¬¦åˆè§„èŒƒ
- [ ] é”™è¯¯å¤„ç†å®Œæ•´
- [ ] å†…å­˜ç®¡ç†æ­£ç¡®
- [ ] æ—¥å¿—è¾“å‡ºåˆç†
- [ ] ä»£ç æ ¼å¼ä¸€è‡´

### å®¡æŸ¥è¦ç‚¹
- [ ] é€»è¾‘æ­£ç¡®æ€§
- [ ] æ€§èƒ½è€ƒè™‘
- [ ] å®‰å…¨æ€§æ£€æŸ¥
- [ ] å¯ç»´æŠ¤æ€§
- [ ] æµ‹è¯•è¦†ç›–

## ðŸ› ï¸ å·¥å…·é…ç½®

### VS Codeé…ç½®
```json
{
    "editor.tabSize": 4,
    "editor.insertSpaces": true,
    "editor.rulers": [100],
    "files.trimTrailingWhitespace": true,
    "files.insertFinalNewline": true,
    "C_Cpp.clang_format_style": "file"
}
```

### .clang-formaté…ç½®
```yaml
BasedOnStyle: Google
IndentWidth: 4
ColumnLimit: 100
AllowShortFunctionsOnASingleLine: None
AllowShortIfStatementsOnASingleLine: false
```

---

ðŸ’¡ **æç¤º**: è‰¯å¥½çš„ç¼–ç è§„èŒƒæ˜¯å›¢é˜Ÿåä½œçš„åŸºç¡€ï¼Œè¯·ä¸¥æ ¼éµå®ˆè¿™äº›è§„èŒƒä»¥ç¡®ä¿ä»£ç è´¨é‡ï¼

ðŸ”— **ç›¸å…³é“¾æŽ¥**:
- [è°ƒè¯•æ–¹æ³•æŒ‡å—](è°ƒè¯•æ–¹æ³•æŒ‡å—.md)
- [Gitç‰ˆæœ¬ç®¡ç†](Gitç‰ˆæœ¬ç®¡ç†.md)
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md)
