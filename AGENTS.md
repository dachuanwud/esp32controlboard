# Repository Guidelines

## Project Structure & Module Organization
- `main/`: ESP-IDF firmware (FreeRTOS tasks, drivers, HTTP server).
- `web_client/`: React + TypeScript UI built with Vite.
- `cloud_server/`: Node/Express unified server and proxy to Supabase/ESP32.
- `docs/`: Architecture and operational docs (primarily Chinese).
- Root config/build: `CMakeLists.txt`, `sdkconfig`, `partitions_16mb_ota.csv`, `Dockerfile`, `docker-compose.yml`.
- `build/`: generated by ESP-IDF; do not edit by hand.

## Build, Test, and Development Commands
- Firmware (ESP-IDF v5.4.1+): `. $IDF_PATH/export.sh`, `idf.py build`, `idf.py -p /dev/ttyUSB0 flash`, `idf.py monitor`, `idf.py size`.
- Web client: `cd web_client && npm install`, then `npm run dev`, `npm run build`, `npm run lint`, `npm run preview`.
- Cloud server: `cd cloud_server && npm install`, then `npm start`, `npm run dev`, `npm test`, `npm run lint`.
- Optional Docker: `docker-compose up -d esp32-dev` (firmware container), `docker-compose up -d web-dev cloud-server`.

## Coding Style & Naming Conventions
- C in `main/`: 4-space indentation, braces on the same line, keep public headers in `main/`, and feature flags in `main.h` (e.g., `CORE_FUNCTION_MODE`).
- TypeScript in `web_client/src/`: 2-space indentation, single quotes, no semicolons, React components in PascalCase.
- Node in `cloud_server/`: 2-space indentation with semicolons; organize by `routes/`, `middleware/`, and `utils/`.
- Linting: ESLint in `web_client` and `cloud_server` via `npm run lint`.

## Testing Guidelines
- Cloud server uses Jest; tests are `cloud_server/test-*.js`. Run from `cloud_server` with `npm test`.
- No automated tests for firmware or web client yet; at minimum run `idf.py build` and a UI smoke check in `npm run dev`. No coverage target is defined.

## Commit & Pull Request Guidelines
- Recent history uses descriptive summaries (often Chinese) and occasional `revert:` prefixes.
- Preferred style is conventional commits (`feat:`, `fix:`, `docs:`, `perf:`, `refactor:`) as documented in `CLAUDE.md`.
- PRs should include a concise summary, test evidence (commands/results), and links to related issues; include screenshots for UI changes.

## Configuration Notes
- Firmware settings live in `sdkconfig` and `partitions_16mb_ota.csv`; edit via ESP-IDF tooling.
- Cloud server defaults are in `cloud_server/config/` and support env vars like `PORT`, `ESP32_DEFAULT_IP`, and `LOG_LEVEL`.
